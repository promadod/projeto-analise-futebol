{% extends 'app_analise/base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Cadastrar Novo Jogo e Suas Estatísticas</h1>
    <p>Preencha os dados da partida abaixo. As médias dos times serão recalculadas automaticamente.</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" class="mt-3 card p-4">
        {% csrf_token %}
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="liga" class="form-label">Liga:</label>
                <select class="form-select" id="liga" name="liga" required>
                    <option selected disabled value="">Selecione a Liga...</option>
                    {% for liga in todas_as_ligas %}
                        <option value="{{ liga.id }}">{{ liga.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="time_casa" class="form-label">Time da Casa:</label>
                <select class="form-select" id="time_casa" name="time_casa" required>
                    </select>
            </div>
            <div class="col-md-4">
                <label for="time_fora" class="form-label">Time de Fora:</label>
                <select class="form-select" id="time_fora" name="time_fora" required>
                    </select>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="data" class="form-label">Data do Jogo:</label>
                <input type="date" class="form-control" id="data" name="data" required>
            </div>
            <div class="col-md-6">
                <label for="rodada" class="form-label">Rodada:</label>
                <input type="number" class="form-control" id="rodada" name="rodada" required>
            </div>
        </div>

        <hr class="my-4">
        
        <h2 class="text-center mb-4">Estatísticas da Partida</h2>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-success text-white text-center">
                        <h4 class="mb-0">1º Tempo</h4>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-6"><label class="form-label">Placar Casa</label><input type="number" name="placar_casa_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Placar Fora</label><input type="number" name="placar_fora_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Finalizações Casa</label><input type="number" name="finalizacao_casa_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Finalizações Fora</label><input type="number" name="finalizacao_fora_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Chutes no Gol Casa</label><input type="number" name="chutes_no_gol_casa_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Chutes no Gol Fora</label><input type="number" name="chutes_no_gol_fora_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Escanteios Casa</label><input type="number" name="escanteios_casa_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Escanteios Fora</label><input type="number" name="escanteios_fora_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Cartões Amarelos Casa</label><input type="number" name="cartoes_amarelos_casa_1t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Cartões Amarelos Fora</label><input type="number" name="cartoes_amarelos_fora_1t" class="form-control" required value="0"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-success text-white text-center">
                        <h4 class="mb-0">2º Tempo</h4>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-6"><label class="form-label">Placar Casa</label><input type="number" name="placar_casa_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Placar Fora</label><input type="number" name="placar_fora_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Finalizações Casa</label><input type="number" name="finalizacao_casa_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Finalizações Fora</label><input type="number" name="finalizacao_fora_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Chutes no Gol Casa</label><input type="number" name="chutes_no_gol_casa_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Chutes no Gol Fora</label><input type="number" name="chutes_no_gol_fora_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Escanteios Casa</label><input type="number" name="escanteios_casa_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Escanteios Fora</label><input type="number" name="escanteios_fora_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Cartões Amarelos Casa</label><input type="number" name="cartoes_amarelos_casa_2t" class="form-control" required value="0"></div>
                            <div class="col-6"><label class="form-label">Cartões Amarelos Fora</label><input type="number" name="cartoes_amarelos_fora_2t" class="form-control" required value="0"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-success btn-lg mt-3">Salvar Jogo e Atualizar Médias</button>
        </div>
    </form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ligaSelect = document.getElementById('liga');
        const timeCasaSelect = document.getElementById('time_casa');
        const timeForaSelect = document.getElementById('time_fora');

        ligaSelect.addEventListener('change', function() {
            const ligaId = this.value;
            
            // Limpa os selects de times
            timeCasaSelect.innerHTML = '<option selected disabled value="">Carregando...</option>';
            timeForaSelect.innerHTML = '<option selected disabled value="">Carregando...</option>';

            if (!ligaId) return;

            // Faz a chamada para a nossa API
            fetch(`/api/get-times/${ligaId}/`)
                .then(response => response.json())
                .then(data => {
                    // Limpa novamente para adicionar os novos times
                    timeCasaSelect.innerHTML = '<option selected disabled value="">Selecione o Time da Casa</option>';
                    timeForaSelect.innerHTML = '<option selected disabled value="">Selecione o Time de Fora</option>';
                    
                    // Adiciona cada time recebido como uma nova opção nos selects
                    data.times.forEach(function(time) {
                        const optionCasa = new Option(time.nome, time.id);
                        const optionFora = new Option(time.nome, time.id);
                        timeCasaSelect.add(optionCasa);
                        timeForaSelect.add(optionFora);
                    });
                })
                .catch(error => console.error('Erro ao buscar times:', error));
        });
    });
</script>

{% endblock %}