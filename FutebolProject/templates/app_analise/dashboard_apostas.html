{% extends 'app_analise/base.html' %}
{% block title %}Dashboard de Desempenho{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho, Filtros e KPIs (Sem alterações) -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard de Desempenho</h1>
        <a href="{% url 'app_analise:lancamento_aposta' %}" class="btn btn-success">+ Nova Aposta</a>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header card-header-custom">Filtros</div>
        <div class="card-body">
            <form method="GET" action="{% url 'app_analise:dashboard_apostas' %}" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="banca" class="form-label">Filtrar por Banca:</label>
                    <select name="banca" id="banca" class="form-select">
                        <option value="">Todas as Bancas</option>
                        {% for banca in bancas %}
                            <option value="{{ banca.pk }}" {% if banca_selecionada_id == banca.pk|stringformat:"s" %}selected{% endif %}>{{ banca.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="periodo" class="form-label">Períodos Rápidos:</label>
                    <select name="periodo" id="periodo" class="form-select">
                        <option value="geral" {% if periodo == 'geral' %}selected{% endif %}>Geral</option>
                        <option value="hoje" {% if periodo == 'hoje' %}selected{% endif %}>Hoje</option>
                        <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Este Mês</option>
                        <option value="ano" {% if periodo == 'ano' %}selected{% endif %}>Este Ano</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">Data de Início:</label>
                    <input type="date" name="data_inicio" id="data_inicio" value="{{ data_inicio_str|default:'' }}" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label">Data Final:</label>
                    <input type="date" name="data_fim" id="data_fim" value="{{ data_fim_str|default:'' }}" class="form-control">
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">Aplicar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Banca Inicial</h5><p class="card-text">R$ {{ banca_inicial|floatformat:2 }}</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Saldo Atual</h5><p class="card-text {% if saldo_atual > banca_inicial %}profit{% else %}loss{% endif %}">R$ {{ saldo_atual|floatformat:2 }}</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Lucro/Prejuízo (Período)</h5><p class="card-text {% if lucro_prejuizo_total > 0 %}profit{% else %}loss{% endif %}">R$ {{ lucro_prejuizo_total|floatformat:2 }}</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">ROI (Período)</h5><p class="card-text {% if roi > 0 %}profit{% else %}loss{% endif %}">{{ roi|floatformat:2 }}%</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Total Apostado</h5><p class="card-text">R$ {{ total_apostado|floatformat:2 }}</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Taxa de Acerto</h5><p class="card-text">{{ taxa_acerto|floatformat:2 }}%</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Odd Média (Green)</h5><p class="card-text">{{ odd_media|floatformat:2 }}</p></div></div></div>
        <div class="col-md-3 mb-4"><div class="card kpi-card"><div class="card-body"><h5 class="card-title">Total de Apostas</h5><p class="card-text">{{ total_apostas }}</p></div></div></div>
    </div>

    <!-- Layout dos Gráficos -->
    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header card-header-custom">Evolução da Banca (Período)</div>
                <div class="card-body"><canvas id="evolucaoBancaChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-5 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header card-header-custom">Resultados (Período)</div>
                <div class="card-body d-flex align-items-center justify-content-center"><canvas id="resultadosPieChart" style="max-height: 250px;"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Desempenho por Mercado -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header card-header-custom">Desempenho por Mercado (Ganhos vs Perdas)</div>
                <div class="card-body"><canvas id="desempenhoMercadoChart" height="120"></canvas></div>
                <div class="card-footer bg-light p-3">
                    <div class="row text-center">
                        <div class="col-12"><h6 class="text-muted mb-3">Resultado Líquido por Mercado</h6></div>
                        {% for mercado in desempenho_mercado_data|slice:":4" %}
                        <div class="col-6 col-md-3">
                            <h6 class="text-muted">{{ mercado.mercado }}</h6>
                            <h4 class="fw-bold {% if mercado.total_retorno > 0 %}text-success{% else %}text-danger{% endif %}">R$ {{ mercado.total_retorno|floatformat:2 }}</h4>
                        </div>
                        {% empty %}
                        <div class="col-12"><p class="text-muted">Nenhum dado de mercado para exibir.</p></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabela de Apostas -->
    <div class="card shadow-sm">
        <div class="card-header card-header-custom">Apostas do Período</div>
        <div class="card-body table-responsive">
            <table class="table table-striped table-hover">
                <thead><tr><th>Data</th><th>Evento</th><th>Banca</th><th>Mercado</th><th>Odd</th><th>Apostado</th><th>Resultado</th><th>Lucro/Prejuízo</th><th>Ações</th></tr></thead>
                <tbody>
                    {% for aposta in ultimas_apostas %}
                    <tr>
                        <td>{{ aposta.data|date:"d/m/Y H:i" }}</td>
                        <td>{{ aposta.evento }}</td>
                        <td>{{ aposta.banca.nome }}</td>
                        <td>{{ aposta.mercado }}</td>
                        <td>{{ aposta.odd }}</td>
                        <td>R$ {{ aposta.valor_apostado|floatformat:2 }}</td>
                        <td><span class="badge {% if aposta.resultado == 'GREEN' %}bg-success{% elif aposta.resultado == 'RED' %}bg-danger{% else %}bg-secondary{% endif %}">{{ aposta.get_resultado_display }}</span></td>
                        <td class="{% if aposta.retorno > 0 %}text-success{% elif aposta.retorno < 0 %}text-danger{% endif %}">R$ {{ aposta.retorno|floatformat:2 }}</td>
                        <td>
                            <a href="{% url 'app_analise:editar_aposta' aposta.id %}" class="btn btn-sm btn-outline-primary">Editar</a>
                            <a href="{% url 'app_analise:deletar_aposta' aposta.id %}" class="btn btn-sm btn-outline-danger">Deletar</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" class="text-center py-4">Nenhuma aposta encontrada para o período selecionado.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Gráficos de Evolução e Pizza (sem alterações)
        const ctxEvolucao = document.getElementById('evolucaoBancaChart');
        if (ctxEvolucao) {
            new Chart(ctxEvolucao, {
                type: 'line',
                data: { labels: {{ datas_evolucao_json|safe }}, datasets: [{ label: 'Saldo da Banca (R$)', data: {{ saldo_evolucao_json|safe }}, borderColor: '#0d6efd', tension: 0.1, fill: false }] }
            });
        }
        const ctxPie = document.getElementById('resultadosPieChart');
        if (ctxPie) {
            new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: ['Green', 'Red'], datasets: [{ label: 'Resultados', data: {{ dados_pie_chart_json|safe }}, backgroundColor: ['#198754', '#dc3545'], hoverOffset: 4 }] }
            });
        }

        // NOVO CÓDIGO PARA O GRÁFICO DE BARRAS AGRUPADAS
        const ctxMercado = document.getElementById('desempenhoMercadoChart');
        if (ctxMercado) {
            new Chart(ctxMercado, {
                type: 'bar',
                data: {
                    labels: {{ mercados_labels_json|safe }},
                    datasets: [
                        {
                            label: 'Ganhos (R$)',
                            data: {{ mercados_ganhos_json|safe }},
                            backgroundColor: 'rgba(25, 135, 84, 0.7)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Perdas (R$)',
                            data: {{ mercados_perdidos_json|safe }},
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}